<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;900&display=swap" rel="stylesheet">
    <title>ColorRider</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script>
      let video;
      let detector;
      let detections = [];
      let colorAnalysisDone = false;
      let lastDetectionTime = 0;
      let camSize = Math.min(600, window.innerWidth);

      function preload() {
        detector = ml5.objectDetector("cocossd", modelLoaded);
      }

      function setup() {
        createCanvas(camSize, camSize);
        var webcam = document.getElementById("webcam-section");
        webcam.appendChild(canvas);
        canvas.style.width = camSize;

        video = createCapture(VIDEO, () => {
          video.size(camSize, camSize);
          video.hide();
        });

        video.elt.addEventListener("loadeddata", () => {
          console.log("Video data loaded");
          detector = ml5.objectDetector("cocossd", modelLoaded); // Initialize the object detector here
        });

        frameRate(10); // Reduce frame rate to ease processing
      }

      function modelLoaded() {
        console.log("Model Loaded!");
        detector.detect(video, gotDetections);
      }

      function gotDetections(error, results) {
        if (error) {
          console.error(error);
          return;
        }

        detections = results;
        colorAnalysisDone = false;
        detector.detect(video, gotDetections);
      }

      function draw() {
        if (video.elt.readyState === 4) {
          // Check if video is ready
          background(255);
          image(video, 0, 0);

          detections.forEach((object) => {
            if (object.label === 'person') return;
            drawDetection(object);
            if (!colorAnalysisDone) {
              analyzeColors(object);
            }
          });
        } else {
          console.log("Waiting for video to be ready");
        }
      }

      function getColor(rgbCode) {
        let meanDeviation = 255;
        let colour = 'unknown';
        for (let i = 0; i < colorSize; i ++) {
          if (rgbCode.r === colours[i][2][0] && rgbCode.g === colours[i][2][1] && rgbCode.b === colours[i][2][0]) {
            colour = colours[i][0];
            return;
          }
          let deviation = (Math.abs(rgbCode.r - colours[i][2][0]) + Math.abs(rgbCode.g - colours[i][2][1]) + Math.abs(rgbCode.b - colours[i][2][2])) / 3;
          if (deviation < meanDeviation) {
            colour = colours[i][0];
            meanDeviation = deviation;
          }
        }
        return colour;
      }

      function drawDetection(object) {
        stroke(50, 0, 50);
        strokeWeight(5);
        noFill();
        rect(object.x, object.y, object.width, object.height);
        noStroke();
        fill(80);
        textSize(27);
        text(object.label, object.x + 15, object.y - 15);

        //Display confidence level
        fill(255, 0, 0); // Set the fill color for the confidence score (e.g., red)
        textSize(20); // Adjust text size if necessary
        text(
          `Confidence: ${(object.confidence * 100).toFixed(2)}%`,
          object.x + 15,
          object.y + object.height + 30
        );
      }

      function analyzeColors(object) {
        video.loadPixels();

        if (video.pixels.length === 0) {
          console.log("Video pixels are not ready");
          return;
        }

        let centerPixel = video.pixels[video.pixels.length / 2];
        let center = { r: video.pixels[centerPixel], g: video.pixels[centerPixel + 1], b: video.pixels[centerPixel + 2] };
        let total = { r: 0, g: 0, b: 0, count: 0 };

        //Iterate through the pixels array
        for (let i = 0; i < video.pixels.length; i += 4) {
          // Each group of 4 values represents the red, green, blue, and alpha channels
          total.r += video.pixels[i];
          total.g += video.pixels[i + 1];
          total.b += video.pixels[i + 2];
          total.count++;
        }

        if (total.count > 0) {
          let avgColor = {
            r: Math.round(total.r / total.count),
            g: Math.round(total.g / total.count),
            b: Math.round(total.b / total.count),
          };

          let colour = getColor(avgColor);
          let objectLabel = object.label;

          fill(avgColor.r, avgColor.g, avgColor.b);
          rect(object.x + object.width + 10, object.y, 50, 50); // Display a rectangle filled with the average color
          fill(0);
          textSize(20);
          text(`Detected Object: ${objectLabel}`, 10, height - 80);
          text(
            `Average Color (RGB): ${avgColor.r}, ${avgColor.g}, ${avgColor.b}`,
            10,
            height - 50
          );
          text(
            `Average Color (Name): ${colour}`,
            10,
            height - 20
          );
        } else {
          console.log("No pixels analyzed for color.");
        }

        colorAnalysisDone = true; // Set flag to true after analysis
      }

      const colours = [
        ["Black", "#000000", [0, 0, 0]],
        ["White", "#FFFFFF", [255, 255, 255]],
        ["Red", "#FF0000", [255, 0, 0]],
        ["Lime", "#00FF00", [0, 255, 0]],
        ["Blue", "#0000FF", [0, 0, 255]],
        ["Yellow", "#FFFF00", [255, 255, 0]],
        ["Cyan", "#00FFFF", [0, 255, 255]],
        ["Magenta", "#FF00FF", [255, 0, 255]],
        ["Silver", "#C0C0C0", [192, 192, 192]],
        ["Gray", "#808080", [128, 128, 128]],
        ["Maroon", "#800000", [128, 0, 0]],
        ["Olive", "#808000", [128, 128, 0]],
        ["Green", "#008000", [0, 128, 0]],
        ["Purple", "#800080", [128, 0, 128]],
        ["Teal", "#008080", [0, 128, 128]],
        ["Navy", "#000080", [0, 0, 128]],
        ["Brown", "#A52A2A", [165, 42, 42]],
        ["Coral", "#FF7F50", [255, 127, 80]],
        ["Salmon", "#FA8072", [250, 128, 114]],
        ["Orange", "#FFA500", [255, 165, 0]],
        ["Gold", "#FFD700", [255, 215, 0]],
        ["Khaki", "#F0E68C", [240, 230, 140]],
        ["Light Green", "#20B2AA", [32, 178, 170]],
        ["Dark Gray", "#2F4F4F", [47, 79, 79]],
        ["teal", "#008080", [0, 128, 128]],
        ["aqua", "#00FFFF", [0, 255, 255]],
        ["dark turquoise", "#00CED1", [0, 206, 209]],
        ["turquoise", "#40E0D0", [64, 224, 208]],
        ["medium turquoise", "#48D1CC", [72, 209, 204]],
        ["pale turquoise", "#AFEEEE", [175, 238, 238]],
        ["aqua marine", "#7FFFD4", [127, 255, 212]],
        ["powder blue", "#B0E0E6", [176, 224, 230]],
        ["cadet blue", "#5F9EA0", [95, 158, 160]],
        ["steel blue", "#4682B4", [70, 130, 180]],
        ["corn flower blue", "#6495ED", [100, 149, 237]],
        ["deep sky blue", "#00BFFF", [0, 191, 255]],
        ["dodger blue", "#1E90FF", [30, 144, 255]],
        ["light blue", "#ADD8E6", [173, 216, 230]],
        ["sky blue", "#87CEEB", [135, 206, 235]],
        ["light sky blue", "#87CEFA", [135, 206, 250]],
        ["midnight blue", "#191970", [25, 25, 112]],
        ["navy", "#000080", [0, 0, 128]],
        ["dark blue", "#00008B", [0, 0, 139]],
        ["medium blue", "#0000CD", [0, 0, 205]],
        ["blue", "#0000FF", [0, 0, 255]],
        ["royal blue", "#4169E1", [65, 105, 225]],
        ["blue violet", "#8A2BE2", [138, 43, 226]],
        ["indigo", "#4B0082", [75, 0, 130]],
        ["dark slate blue", "#483D8B", [72, 61, 139]],
        ["slate blue", "#6A5ACD", [106, 90, 205]],
        ["medium slate blue", "#7B68EE", [123, 104, 238]],
        ["dark violet", "#9400D3", [148, 0, 211]],
        ["dark orchid", "#9932CC", [153, 50, 204]],
        ["medium orchid", "#BA55D3", [186, 85, 211]],
        ["purple", "#800080", [128, 0, 128]],
        ["thistle", "#D8BFD8", [216, 191, 216]],
        ["plum", "#DDA0DD", [221, 160, 221]],
        ["violet", "#EE82EE", [238, 130, 238]],
        ["orchid", "#DA70D6", [218, 112, 214]],
        ["deep pink", "#FF1493", [255, 20, 147]],
        ["hot pink", "#FF69B4", [255, 105, 180]],
        ["light pink", "#FFB6C1", [255, 182, 193]],
        ["pink", "#FFC0CB", [255, 192, 203]],
        ["beige", "#F5F5DC", [245, 245, 220]],
        ["bisque", "#FFE4C4", [255, 228, 196]],
        ["blanched almond", "#FFEBCD", [255, 235, 205]],
        ["wheat", "#F5DEB3", [245, 222, 179]],
        ["corn silk", "#FFF8DC", [255, 248, 220]],
        ["lemon chiffon", "#FFFACD", [255, 250, 205]],
        ["light golden rod yellow", "#FAFAD2", [250, 250, 210]],
        ["light yellow", "#FFFFE0", [255, 255, 224]],
        ["saddle brown", "#8B4513", [139, 69, 19]],
        ["sienna", "#A0522D", [160, 82, 45]],
        ["chocolate", "#D2691E", [210, 105, 30]],
        ["peru", "#CD853F", [205, 133, 63]],
        ["sandy brown", "#F4A460", [244, 164, 96]],
        ["burly wood", "#DEB887", [222, 184, 135]],
        ["tan", "#D2B48C", [210, 180, 140]],
        ["rosy brown", "#BC8F8F", [188, 143, 143]],
        ["moccasin", "#FFE4B5", [255, 228, 181]],
        ["peach puff", "#FFDAB9", [255, 218, 185]],
        ["misty rose", "#FFE4E1", [255, 228, 225]],
        ["lavender blush", "#FFF0F5", [255, 240, 245]],
        ["linen", "#FAF0E6", [250, 240, 230]],
        ["old lace", "#FDF5E6", [253, 245, 230]],
        ["papaya whip", "#FFEFD5", [255, 239, 213]],
        ["sea shell", "#FFF5EE", [255, 245, 238]],
        ["mint cream", "#F5FFFA", [245, 255, 250]],
        ["lavender", "#E6E6FA", [230, 230, 250]],
        ["honeydew", "#F0FFF0", [240, 255, 240]],
        ["ivory", "#FFFFF0", [255, 255, 240]],
        ["azure", "#F0FFFF", [240, 255, 255]],
        ["snow", "#FFFAFA", [255, 250, 250]],
      ]
      const colorSize = colours.length;
    </script>
  </body>
</html>
